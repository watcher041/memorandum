
# 備忘録（CentOS）

## grubcfgにエラーが発生したときの対応

```
 代理ブートで復旧を行う

 isoファイルを入れる

 trubleshooting > Rescue ~ を選択

 continue（1）を選択すると、代理ブートが始まる

 このとき、ルートディレクトリが変わっているので
 
 chroot /mnt/sysimage → 表示される文章から確認

 さっき、grubのコマンドが出ていたので、grubで異常が起こっていることを予想して
 関連するファイルを捜索する。

 grub.cfg → これがないことがわかる。
 
 grub.cfgを以下のコマンドで再生成する。
 grub2-mkconfig -o /boot/grub2/grub.cfg

 -------------------------------------------------------------------------------

 karnel panic時の再起動

 /proc/sys/kernel/panic → 0 （OSが止まる）
                             10 （10秒後に再起動する）

```

## rootパスワードのリセット

```

 予め、grubの設定を変更する必要がある、SELinuxを止める必要もある。

 /etc/selinux/config → SELINUX=disabled に変更

 # getenforce → SELinuxが止まっているかを確認

 再起動して、起動画面においてeキーを押て、linux16の欄の最後に以下の項目を追加
 （emergency modeに入る）

 rd.break
 
 起動後、読み書きできるように再マウンドを行う

 switch_root:/#mount -o remount,rw /sysroot

 居場所を分かり易くするために、rootフォルダを変更する

 chroot /sysroot

 日本語に対応させるために、以下を実行

 sh#LANG=C

 パスワードの変更

 #passwd root

```

## SUID確認コマンド

```
find / -perm -u+s -exec ls -l {} \; 2> /dev/null > /var/tmp/suid.txt
```

## webサーバーの構築、名前解決

```
　1. PCを3つの用意する（WEBサーバ、DNSサーバ、WEBサーバーに接続するためのPC）
　　 以降の説明の為、順にPC1、PC2、PC3と名前をつける。

　2. PC1にCentOS7をインストールする。このとき、以下の項目に注意すること。
　　　
　　・インストール先を自分がインストールしたいHDDに指定する
　　・ネットワークをonにする
　　・rootユーザーのパスワードを設定する
　　・ユーザー作成などの項目では何もせず放置する

　3. CUIが起動したら、ユーザーを作成していく

　　#adduser newuser
　　#passwd newuser

　4. 新しく作成したユーザーにroot権限を付与する

　　#usermod -aG wheel newuser

　　編集にnanoを用いる場合には、以下を実行
　　#export EDITOR=nano
　　#yum install -y nano

　　#visudo
　　→「root ALL=(ALL)  ALL」の下に、「newuser ALL=(ALL)  ALL」を追記する

　5. 新しく作成したユーザーに管理者権限が付与されたか確認する

　　#su - newuser
　　$sudo yum -y update
　　#exit
　　#exit → 改めて、newuserでログインする

　6. WEBサーバーに必要なパッケージ（Apache）の設定をする

　　$sudo yum install -y httpd
　　$sudo systemctl enable httpd
　　$sudo firewall-cmd  --permanent --zone=public --add-service=http
　　$sudo firewall-cmd --reload 
　
　7. /var/www/html配下にindex.htmlを置くことで、ブラウザからIPアドレスを入力することでページが閲覧できる

　　$ip a → WEBサーバーのIPアドレスが確認できる

　8. PC2にCentOS7をインストールする。手順は先ほどと同じ。

　9. DNSサーバーを構築する前に、SELinuxを一時的に無効化しておく

　　#setenforce 0

　10. DNSサーバ構築に必要なパッケージをインストールする

　　#yum install -y bind bind-chroot bind-utils

　　bind-chrootの役割とは
　　通常、bindのルートディレクトリは/ですが、bind-chrootを利用することで/var/named/chrootがルートディレクトリになり、
　　bindのプロセスがアクセス可能なディレクトリ領域を制限することが出来ます。
　　※bindのプロセスが/var/named/chrootより上のディレクトリへアクセスできない状態で環境構築される。
　　　セキュリティの観点から、bindでのDNSサーバ構築時には、bind-chrootの利用が推奨されているようです。

　11. named-chrootをONにする

　　#systemctl disable named.service
　　#systemctl enable named-chroot
　　#systemctl start named-chroot

　12. 万が一失敗したときのことを考え、名前解決に必要なファイルのバックアップをとる

　　#cp -p /var/named/chroot/etc/named.conf /var/named/chroot/etc/named.conf.original

　13. /var/named/chroot/etc/named.conf を編集する

　　・allow-query { localhost; }; → allow-query { any;};
　　問い合わせするIPを制限する場合には、以下のように指定
　　許可リストを作成する【特定IP許可リスト作成】
　　allow-query { trust;};
　　acl trust {
　　　192.168.1.0/24;
　　　localhost;
　　};
　　・listen-on port 53 { 127.0.0.1; }; → listen-on port 53 { 127.0.0.1;PC2のIPアドレス; };
　　・ゾーンファイル（正引き）との紐づけ
　　　zone "example.com" IN {
　　　  type master;
　　　  file "example.com.zone";
　　　};

　14. ゾーンファイル（example.com.zone）の作成

　　　　#cp -p /var/named/chroot/var/named/named.localhost /var/named/chroot/var/named/example.com.zone

　15. ゾーンファイル（ /var/named/chroot/var/named/example.com.zone）を編集

　　$TTL 1D
　　@ IN SOA ns.example.com. root.example.com. (
　　0 ; serial
　　1D ; refresh
　　1H ; retry
　　1W ; expire
　　3H ) ; minimum
　　IN NS ns.example.com.
　　@ IN A PC1のIPアドレス
　　ns IN A PC2のIPアドレス

   www    	IN     	CNAME   @

　
　16. リゾルバファイル（/etc/resolv.conf）を編集

　　# Generated by NetworkManager
　　search flets-east.jp iptvf.jp
　　nameserver 127.0.0.1
　　nameserver 2400:4070:333e:3c00:225:dcff:fe2b:a798

　17. bind-chrootを再起動し、動作確認を行う

　　#systemctl restart named-chroot
　　#nslookup example.com → WEBサーバーのIPアドレスが表示される
　　#ss -atnu → UDP 53 : DNSが開放されているか確認する。
　　#firewall-cmd --permanent --add-port=53/udp → 開放されていない場合
　　#firewall-cmd --reload

　18. 実際に名前解決できるか、PC3から確認を行う

　　>nslookup 名前解決するドメイン名 DNSサーバーのIPアドレス
　　（DNSサーバーのIPアドレスを省略したい場合には、プロトコルバージョンから優先するDNSを手動で設定する）

　19. 本来であればドメイン名を入力するとページが表示されるが、http://www.example.comではなく、仕様により
　　　https://www.example.comにリダイレクトされるため、WEBサーバーをhttpsに対応させる必要がある。

　　　https … SSLを用いたhttp通信、信頼されたサーバーしか通信を行うわないような規格

　20. SELinuxがhttpdの起動を妨げるため、解除する

問題の原因：
　自分で構築したDNSサーバーを通じてURLをIPアドレスに変換しようとしたが、
　DNSサーバーとして自作したもののと同時に外部のものも設定していたことで、
　自作のDNSサーバからの応答が遅いときに外部のDNSサーバーの結果が返ってき
てしまった。
　例：　目当てのIP：192.168.0.12　→　実際：29.1.123.3
　および、一度使用したDNSサーバーの情報がOS、ブラウザに記録されて、再度
サイトを見ようとしたときに
　同じDNSサーバーに問い合わせ続けてしまっていた）
　→ ブラウザおよびOSに記録されたDNS情報を削除し、自作したDNSのみを指定す
ることで解決
　メールサーバの構築について、全体像を掴むことができたこと。

```

## フォルダ内のサイズ調査

```
　以下のコマンドを使用すると、パーティションごとのサイズが表示される
　df -Th 

　この中で見たいものがあれば、以下のコマンドを実行
　du -s /boot/* | sort -n → サイズ大きさごとに表示される。

　これを続けていくと、パーティションを逼迫させているファイルを探すことができる。

　一方でファイル数を調べるとなると、個別に調べるしかない
　ls -Ul /boot/grub | wc -l → 出力された行数を数えて、ファイル数を数える（各ファイルで行う）

```

## ブート時の詳細表示方法

```
 /etc/default

 cp grub grub_origin

 grub内の以下を削除
 rhgb quiet

 /boot/grub2
 
 cp grub.cfg grub.cfg_origin

 grub2-mkconfig -o /boot/grub2/

```